<script>
  // Thème sombre/clair
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    
    // Mise à jour des styles pour le mode sombre
    if (isDarkMode) {
      document.querySelector('.container').style.backgroundColor = 'rgba(30, 41, 59, 0.9)';
      document.querySelector('.container').style.color = '#ffffff';
    } else {
      document.querySelector('.container').style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
      document.querySelector('.container').style.color = '#000000';
    }
  }

  // Initialisation du thème
  function initTheme() {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
      document.querySelector('.container').style.backgroundColor = 'rgba(30, 41, 59, 0.9)';
      document.querySelector('.container').style.color = '#ffffff';
    }
  }

  // Recherche et filtrage
  function filterRules(searchTerm) {
    const ruleLines = document.querySelectorAll('.rule-line');
    ruleLines.forEach(line => {
      const text = line.textContent.toLowerCase();
      const isVisible = text.includes(searchTerm.toLowerCase());
      line.style.display = isVisible ? 'grid' : 'none';
    });
  }

  // Export CSV
  function exportToCSV() {
    const rules = [];
    const ruleLines = document.querySelectorAll('.rule-line');
    ruleLines.forEach(line => {
      const sourceIp = line.querySelector('.sourceIp').value;
      const destinationIp = line.querySelector('.destinationIp').value;
      const protocol = line.querySelector('.protocol').value;
      const port = line.querySelector('.port').value;
      if (sourceIp && destinationIp) {
        rules.push([sourceIp, destinationIp, protocol, port].join(','));
      }
    });
    
    const csvContent = "data:text/csv;charset=utf-8," + rules.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "network_rules.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Import CSV
  function importFromCSV(file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      const csvData = event.target.result;
      const lines = csvData.split('\n');
      lines.forEach(line => {
        const [sourceIp, destinationIp, protocol, port] = line.split(',');
        if (sourceIp && destinationIp) {
          duplicateField('source');
          const lastLine = document.querySelector('.rule-line:last-child');
          lastLine.querySelector('.sourceIp').value = sourceIp;
          lastLine.querySelector('.destinationIp').value = destinationIp;
          lastLine.querySelector('.protocol').value = protocol;
          lastLine.querySelector('.port').value = port;
        }
      });
    };
    reader.readAsText(file);
  }

      function validateIpFormat(ip) {
        const regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
        if (!regex.test(ip)) return false;
        
        const parts = ip.split('.');
        return parts.every(part => {
          const num = parseInt(part);
          return num >= 0 && num <= 255;
        });
      }

      function validatePort(port) {
        const portNum = parseInt(port);
        return portNum >= 1 && portNum <= 65000;
      }

      function validateFourCharField(value) {
        return value.length === 4;
      }

</script>