<script>
let rules = [];

function validateIpFormat(ip) {
  const regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
  if (!regex.test(ip)) return false;
  
  const parts = ip.split('.');
  return parts.every(part => {
    const num = parseInt(part);
    return num >= 0 && num <= 255;
  });
}

function validatePort(port) {
  const portNum = parseInt(port);
  return portNum >= 1 && portNum <= 65535;
}

function duplicateField(type) {
  const container = document.querySelector('.container');
  const newRuleLine = document.createElement('div');
  newRuleLine.className = 'rule-line';
  
  // Récupérer les valeurs actuelles
  const sourceIp = document.getElementById('sourceIp').value;
  const destinationIp = document.getElementById('destinationIp').value;
  const protocol = document.getElementById('protocol').value;
  const port = document.getElementById('port').value;

  // Créer le HTML pour la nouvelle ligne
  newRuleLine.innerHTML = `
    <div class="rule-column">
      <input type="text" class="input-field sourceIp" placeholder="IP source" value="${type === 'source' ? '' : sourceIp}">
      <button onclick="duplicateField('source')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <input type="text" class="input-field destinationIp" placeholder="IP destination" value="${type === 'destination' ? '' : destinationIp}">
      <button onclick="duplicateField('destination')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <select class="input-field protocol">
        <option value="ssh" ${type !== 'protocol' && protocol === 'ssh' ? 'selected' : ''}>SSH</option>
        <option value="https" ${type !== 'protocol' && protocol === 'https' ? 'selected' : ''}>HTTPS</option>
        <option value="ping" ${type !== 'protocol' && protocol === 'ping' ? 'selected' : ''}>PING</option>
        <option value="smtp" ${type !== 'protocol' && protocol === 'smtp' ? 'selected' : ''}>SMTP</option>
      </select>
      <button onclick="duplicateField('protocol')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <input type="number" class="input-field port" placeholder="Port" min="1" max="65535" value="${type === 'port' ? '' : port}">
      <button onclick="duplicateField('port')" class="add-button">+</button>
    </div>
  `;

  // Insérer la nouvelle ligne après la dernière ligne de règle
  const lastRuleLine = document.querySelector('.rule-line:last-child');
  lastRuleLine.parentNode.insertBefore(newRuleLine, lastRuleLine.nextSibling);

  // Focus sur le champ vidé
  if (type === 'source') {
    newRuleLine.querySelector('.sourceIp').focus();
  } else if (type === 'destination') {
    newRuleLine.querySelector('.destinationIp').focus();
  } else if (type === 'protocol') {
    newRuleLine.querySelector('.protocol').focus();
  } else if (type === 'port') {
    newRuleLine.querySelector('.port').focus();
  }
}

function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.classList.remove('hidden');
  notification.classList.toggle('error', isError);
  
  setTimeout(() => {
    notification.classList.add('hidden');
  }, 3000);
}
</script>