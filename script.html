<script>
let rules = [];

function validateIpFormat(ip) {
  const regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
  if (!regex.test(ip)) return false;
  
  const parts = ip.split('.');
  return parts.every(part => {
    const num = parseInt(part);
    return num >= 0 && num <= 255;
  });
}

function validatePort(port) {
  const portNum = parseInt(port);
  return portNum >= 1 && portNum <= 65000;
}

function duplicateField(type) {
  const container = document.querySelector('.container');
  const newRuleLine = document.createElement('div');
  newRuleLine.className = 'rule-line';
  
  // Récupérer les valeurs actuelles
  const sourceIp = document.getElementById('sourceIp').value;
  const destinationIp = document.getElementById('destinationIp').value;
  const protocol = document.getElementById('protocol').value;
  const port = document.getElementById('port').value;

  // Créer le HTML pour la nouvelle ligne
  newRuleLine.innerHTML = `
    <div class="rule-column">
      <input type="text" class="input-field sourceIp" placeholder="IP source" value="${type === 'source' ? '' : sourceIp}" oninput="validateInput(this, 'ip')">
      <button onclick="duplicateField('source')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <input type="text" class="input-field destinationIp" placeholder="IP destination" value="${type === 'destination' ? '' : destinationIp}" oninput="validateInput(this, 'ip')">
      <button onclick="duplicateField('destination')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <select class="input-field protocol">
        <option value="ssh" ${type !== 'protocol' && protocol === 'ssh' ? 'selected' : ''}>SSH</option>
        <option value="https" ${type !== 'protocol' && protocol === 'https' ? 'selected' : ''}>HTTPS</option>
        <option value="ping" ${type !== 'protocol' && protocol === 'ping' ? 'selected' : ''}>PING</option>
        <option value="smtp" ${type !== 'protocol' && protocol === 'smtp' ? 'selected' : ''}>SMTP</option>
      </select>
      <button onclick="duplicateField('protocol')" class="add-button">+</button>
    </div>
    <div class="rule-column">
      <input type="text" class="input-field port" placeholder="Port" value="${type === 'port' ? '' : port}" oninput="validateInput(this, 'port')">
      <button onclick="duplicateField('port')" class="add-button">+</button>
    </div>
  `;

  // Insérer la nouvelle ligne après la dernière ligne de règle
  const lastRuleLine = document.querySelector('.rule-line:last-child');
  lastRuleLine.parentNode.insertBefore(newRuleLine, lastRuleLine.nextSibling);

  // Focus sur le champ vidé
  if (type === 'source') {
    newRuleLine.querySelector('.sourceIp').focus();
  } else if (type === 'destination') {
    newRuleLine.querySelector('.destinationIp').focus();
  } else if (type === 'protocol') {
    newRuleLine.querySelector('.protocol').focus();
  } else if (type === 'port') {
    newRuleLine.querySelector('.port').focus();
  }
}

function validateInput(input, type) {
  if (type === 'ip') {
    if (!validateIpFormat(input.value) && input.value !== '') {
      input.style.borderColor = 'red';
      showNotification('Veuillez saisir une adresse IP valide (format: 0-255.0-255.0-255.0-255)', true);
    } else {
      input.style.borderColor = '#e2e8f0';
    }
  } else if (type === 'port') {
    const value = input.value.replace(/[^0-9]/g, '');
    input.value = value;
    
    if (!validatePort(value) && value !== '') {
      input.style.borderColor = 'red';
      showNotification('Le port doit être compris entre 1 et 65000', true);
    } else {
      input.style.borderColor = '#e2e8f0';
    }
  }
}

function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.classList.remove('hidden');
  notification.classList.toggle('error', isError);
  
  setTimeout(() => {
    notification.classList.add('hidden');
  }, 3000);
}

// Ajouter les validations aux champs existants
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('sourceIp').addEventListener('input', function() {
    validateInput(this, 'ip');
  });
  
  document.getElementById('destinationIp').addEventListener('input', function() {
    validateInput(this, 'ip');
  });
  
  document.getElementById('port').addEventListener('input', function() {
    validateInput(this, 'port');
  });
});
</script>