<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      google.charts.load('current', {'packages':['sankey']});
      
      function drawTopology(data) {
        if (!data || data.length === 0) {
          document.getElementById('error-message').textContent = 'Aucune donnée à afficher';
          document.getElementById('error-message').style.display = 'block';
          return;
        }

        const container = document.getElementById('topology');
        const chart = new google.visualization.Sankey(container);
        
        try {
          // Préparation des données
          const dataTable = new google.visualization.DataTable();
          dataTable.addColumn('string', 'From');
          dataTable.addColumn('string', 'To');
          dataTable.addColumn('number', 'Weight');
          
          // Map pour stocker les connexions uniques
          const uniqueConnections = new Map();
          
          // Traitement des données pour éviter les cycles
          data.forEach(rule => {
            const key = `${rule.sourceIp}-${rule.destinationIp}`;
            if (!uniqueConnections.has(key)) {
              uniqueConnections.set(key, {
                from: rule.sourceIp,
                to: rule.destinationIp,
                weight: 1
              });
            } else {
              // Incrémenter le poids si la connexion existe déjà
              const connection = uniqueConnections.get(key);
              connection.weight += 1;
            }
          });
          
          // Conversion des connexions uniques en tableau de données
          const rows = Array.from(uniqueConnections.values()).map(conn => [
            conn.from,
            conn.to,
            conn.weight
          ]);
          
          dataTable.addRows(rows);

          // Options du graphique
          const options = {
            width: 900,
            height: 600,
            sankey: {
              node: {
                colors: ['#a6cee3', '#1f78b4', '#b2df8a'],
                label: {
                  fontSize: 14,
                  color: '#000000',
                  bold: true
                },
                nodePadding: 80
              },
              link: {
                colorMode: 'gradient',
                fillOpacity: 0.8
              }
            }
          };

          chart.draw(dataTable, options);
          document.getElementById('error-message').style.display = 'none';
        } catch (error) {
          console.error('Erreur lors de la création du graphique:', error);
          document.getElementById('error-message').textContent = 'Erreur lors de la création du graphique';
          document.getElementById('error-message').style.display = 'block';
        }
      }

      // Fonction pour récupérer et afficher les données
      function loadTopologyData() {
        google.script.run
          .withSuccessHandler(drawTopology)
          .withFailureHandler(function(error) {
            console.error('Erreur lors du chargement des données:', error);
            document.getElementById('error-message').textContent = 'Erreur lors du chargement des données';
            document.getElementById('error-message').style.display = 'block';
          })
          .getNetworkRules();
      }

      // Fonction pour fermer la fenêtre
      function closeTopology() {
        google.script.host.close();
      }
    </script>
    <style>
      #topology {
        width: 100%;
        height: calc(100vh - 60px);
        padding: 20px;
      }
      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        background-color: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .close-button:hover {
        background-color: #dc2626;
      }
      #error-message {
        display: none;
        color: #ef4444;
        text-align: center;
        padding: 20px;
        font-size: 16px;
        font-weight: bold;
      }
    </style>
  </head>
  <body onload="loadTopologyData()">
    <button onclick="closeTopology()" class="close-button">Fermer</button>
    <div id="error-message"></div>
    <div id="topology"></div>
  </body>
</html>